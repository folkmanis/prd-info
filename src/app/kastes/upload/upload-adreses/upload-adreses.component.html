<div [formGroup]="checkCols">

    <button *cdkPortal class="button-row" mat-raised-button (click)="onAddEmptyColumn()"
        [disabled]="!(datasource$ | async)?.length">Pievienot tukšu sleju</button>
    <button *cdkPortal class="button-row" mat-raised-button (click)="onDeleteColumns(checkCols.controls.columns.value)"
        [disabled]="!(chkColCount$ | async)">Dzēst slejas</button>
    <button *cdkPortal class="button-row" mat-raised-button (click)="onJoinColumns(checkCols.controls.columns.value)"
        [disabled]="(chkColCount$ | async) < 2">Apvienot slejas</button>
    <span [formGroup]="settingsControl">
        <mat-checkbox *cdkPortal class="button-row" formControlName="toPakas"> Jādala ar 500 </mat-checkbox>
        <mat-checkbox *cdkPortal class="button-row" formControlName="mergeAddress"> Apvienot adreses </mat-checkbox>
    </span>

    <div class="chips-bar">
        <mat-chip-set>
            @for (col of chipsAvailable$ | async; track $index) {
            <mat-chip color="primary" [appDragable]="col" dragSource="primary">
                {{col}}
            </mat-chip>
            }
        </mat-chip-set>
    </div>

    @if (columns$ | async; as columns) {
    <table mat-table class="app-table" [dataSource]="datasource$" formArrayName="columns">
        <ng-container matColumnDef="selected">
            <th mat-header-cell *matHeaderCellDef></th>
            <td mat-cell *matCellDef="let row; index as idx;">
                <mat-checkbox (click)="$event.stopPropagation()" (change)="rowSelection.toggle(idx)"
                    [checked]="rowSelection.isSelected(idx)">
                </mat-checkbox>
            </td>
        </ng-container>

        @for (col of columns; let colIdx = $index; track colIdx) {
        <ng-container [matColumnDef]="col">
            <th mat-header-cell *matHeaderCellDef>
                @if (chipsAssignement$ | async; as assignement) {
                <div>
                    <div class="drop-target" appDragDrop (dropEmitter)="onDrop($event, col)">
                        <mat-chip-set>
                            @if (isChipAssigned(assignement, col); as chipName) {
                            <mat-chip color="primary" [appDragable]="chipName" removable [dragSource]="col"
                                (removed)="onChipRemove(col)">
                                {{chipName}}
                                <mat-icon matChipRemove>cancel</mat-icon>
                            </mat-chip>
                            }
                        </mat-chip-set>
                    </div>
                    <div class="column-check">
                        <mat-checkbox [formControlName]="colIdx"></mat-checkbox>
                    </div>
                </div>
                }
            </th>
            <td mat-cell *matCellDef="let row;">{{row[col]}}</td>
        </ng-container>
        }

        <tr mat-header-row *matHeaderRowDef="columnsWithSelected(columns)"></tr>
        <tr mat-row *matRowDef="let row; columns: columnsWithSelected(columns)"></tr>
    </table>
    }
</div>